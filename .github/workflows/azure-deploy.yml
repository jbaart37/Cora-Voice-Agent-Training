name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: 'Environment name (e.g., dev, prod, test)'
        required: true
        default: 'dev'
      location:
        description: 'Azure region'
        required: true
        default: 'eastus'
        type: choice
        options:
          - eastus
          - eastus2
          - westus2
          - westeurope
          - northeurope
      resource_group_name:
        description: 'Resource group name (leave empty to auto-generate based on environment name)'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install azd
        run: |
          curl -fsSL https://aka.ms/install-azd.sh | bash
          azd version
        shell: bash

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Log in to azd
        run: |
          azd auth login --client-id "${{ secrets.AZURE_CLIENT_ID }}" \
            --client-secret "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant-id "${{ secrets.AZURE_TENANT_ID }}"
        shell: bash

      - name: Set azd environment variables
        working-directory: ${{ github.workspace }}
        run: |
          # Create new azd environment (this creates .azure/ENV_NAME/.env with quoted values)
          azd env new ${{ github.event.inputs.environment_name }} --location ${{ github.event.inputs.location }} --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          
          # Completely overwrite .env file with unquoted values for infrastructure parameters
          # This ensures no quotes interfere with Bicep parameter parsing
          cat > .azure/${{ github.event.inputs.environment_name }}/.env << 'EOF'
AZURE_ENV_NAME=${{ github.event.inputs.environment_name }}
AZURE_LOCATION=${{ github.event.inputs.location }}
AZURE_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}
environmentName=${{ github.event.inputs.environment_name }}
location=${{ github.event.inputs.location }}
azureOpenAIEndpoint=${{ secrets.AZURE_OPENAI_ENDPOINT }}
modelName=${{ secrets.AZURE_OPENAI_MODEL_NAME }}
EOF
          
          # Add optional resource group name if provided
          if [ -n "${{ github.event.inputs.resource_group_name }}" ]; then
            echo "resourceGroupName=${{ github.event.inputs.resource_group_name }}" >> .azure/${{ github.event.inputs.environment_name }}/.env
          fi
        shell: bash

      - name: Debug azd environment setup
        working-directory: ${{ github.workspace }}
        run: |
          echo "=== Current directory ==="
          pwd
          ls -lh
          
          echo "=== azd version ==="
          azd version
          
          echo "=== azure.yaml location ==="
          find . -name azure.yaml -type f
          
          echo "=== .azure directory structure ==="
          ls -lah .azure/
          ls -lah .azure/${{ github.event.inputs.environment_name }}/
          
          echo "=== Contents of .env file ==="
          cat .azure/${{ github.event.inputs.environment_name }}/.env
          
          echo "=== azd env get-values output ==="
          azd env get-values
        shell: bash

      - name: Provision and Deploy
        working-directory: ${{ github.workspace }}
        run: |
          echo "Starting provisioning with parameters from .env file..."
          echo "Current directory: $(pwd)"
          echo "Using azd environment: $(azd env get-values | grep AZURE_ENV_NAME)"
          azd provision --no-prompt
          
          echo "Deploying application..."
          azd deploy --no-prompt
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_ENV_NAME: ${{ github.event.inputs.environment_name }}
          AZURE_LOCATION: ${{ github.event.inputs.location }}

      - name: Get deployment outputs
        id: outputs
        run: |
          WEB_URI=$(azd env get-values | grep WEB_URI | cut -d '=' -f2 | tr -d '"')
          echo "web_uri=$WEB_URI" >> $GITHUB_OUTPUT

      - name: Display deployment URL
        run: |
          echo "ğŸ‰ Deployment complete!"
          echo "ğŸŒ Application URL: ${{ steps.outputs.outputs.web_uri }}"
