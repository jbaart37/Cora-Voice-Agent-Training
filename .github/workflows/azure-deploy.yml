name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: 'Environment name (e.g., dev, prod, test)'
        required: true
        default: 'dev'
      location:
        description: 'Azure region'
        required: true
        default: 'eastus'
        type: choice
        options:
          - eastus
          - eastus2
          - westus2
          - westeurope
          - northeurope
      resource_group_name:
        description: 'Resource group name (leave empty to auto-generate based on environment name)'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install latest stable azd
        run: |
          curl -fsSL https://aka.ms/install-azd.sh | bash
          azd version
        shell: bash

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Log in to azd
        run: |
          azd auth login --client-id "${{ secrets.AZURE_CLIENT_ID }}" \
            --client-secret "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant-id "${{ secrets.AZURE_TENANT_ID }}"
        shell: bash

      - name: Set azd environment variables
        working-directory: ${{ github.workspace }}
        run: |
          # Create new azd environment
          azd env new ${{ github.event.inputs.environment_name }} --location ${{ github.event.inputs.location }} --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          
          # Forcibly overwrite .env with only infra keys (no azd metadata)
          cat > .azure/${{ github.event.inputs.environment_name }}/.env <<EOF
          environmentName=${{ github.event.inputs.environment_name }}
          location=${{ github.event.inputs.location }}
          azureOpenAIEndpoint=${{ secrets.AZURE_OPENAI_ENDPOINT }}
          modelName=${{ secrets.AZURE_OPENAI_MODEL_NAME }}
          resourceGroupName=${{ github.event.inputs.resource_group_name }}
          EOF
          
          echo "=== Contents of .env file (with hidden chars) ==="
          cat -A .azure/${{ github.event.inputs.environment_name }}/.env
        shell: bash

      - name: Debug azd environment setup
        working-directory: ${{ github.workspace }}
        run: |
          echo "=== Current directory ==="
          pwd
          ls -lh
          
          echo "=== azd version ==="
          azd version
          
          echo "=== azure.yaml location ==="
          find . -name azure.yaml -type f
          
          echo "=== .azure directory structure ==="
          ls -lah .azure/
          ls -lah .azure/${{ github.event.inputs.environment_name }}/
          
          echo "=== Contents of .env file (with hidden characters) ==="
          cat .azure/${{ github.event.inputs.environment_name }}/.env | cat -A
          
          echo "=== azd env get-values output ==="
          azd env get-values
          
          echo "=== azure.yaml parameters section ==="
          awk '/parameters:/,/^infra:/' azure.yaml
          
          echo "=== First 10 lines of main.bicep ==="
          head -n 10 infra/main.bicep
          
          echo "=== Selecting azd environment explicitly ==="
          azd env select ${{ github.event.inputs.environment_name }}
        shell: bash

      - name: Provision with Azure CLI (bypass azd bug)
        working-directory: ${{ github.workspace }}
        run: |
          echo "Provisioning Azure resources using Azure CLI directly (bypassing azd v1.22.5 bug)..."
          
          DEPLOYMENT_NAME="voiceagent-$(date +%Y%m%d-%H%M%S)"
          
          # Determine resource group name
          RG_NAME="${{ github.event.inputs.resource_group_name }}"
          if [ -z "$RG_NAME" ]; then
            RG_NAME="rg-${{ github.event.inputs.environment_name }}"
          fi
          
          echo "Deploying to subscription: ${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          echo "Resource group: $RG_NAME"
          echo "Deployment name: $DEPLOYMENT_NAME"
          
          # Pre-create resource group to avoid ARM deployment errors
          echo "Creating resource group if it doesn't exist..."
          az group create --name "$RG_NAME" --location "${{ github.event.inputs.location }}"
          
          # Deploy Bicep template using Azure CLI
          az deployment sub create \
            --name "$DEPLOYMENT_NAME" \
            --location "${{ github.event.inputs.location }}" \
            --template-file infra/main.bicep \
            --parameters environmentName="${{ github.event.inputs.environment_name }}" \
            --parameters location="${{ github.event.inputs.location }}" \
            --parameters azureOpenAIEndpoint="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
            --parameters modelName="${{ secrets.AZURE_OPENAI_MODEL_NAME }}" \
            --parameters resourceGroupName="$RG_NAME"
          
          echo "Provisioning completed successfully!"
          
          # Store outputs for azd deploy
          OUTPUTS=$(az deployment sub show --name "$DEPLOYMENT_NAME" --query properties.outputs -o json)
          echo "Deployment outputs: $OUTPUTS"
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy application with azd
        working-directory: ${{ github.workspace }}
        run: |
          echo "Deploying application..."
          azd deploy --no-prompt
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_ENV_NAME: ${{ github.event.inputs.environment_name }}
          AZURE_LOCATION: ${{ github.event.inputs.location }}

      - name: Get deployment outputs
        id: outputs
        run: |
          WEB_URI=$(azd env get-values | grep WEB_URI | cut -d '=' -f2 | tr -d '"')
          echo "web_uri=$WEB_URI" >> $GITHUB_OUTPUT

      - name: Display deployment URL
        run: |
          echo "ğŸ‰ Deployment complete!"
          echo "ğŸŒ Application URL: ${{ steps.outputs.outputs.web_uri }}"
